<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrainStorming Quiz</title>
    <script
      src="https://unpkg.com/htmx.org@2.0.0/dist/htmx.js"
      integrity="sha384-Xh+GLLi0SMFPwtHQjT72aPG19QvKB8grnyRbYBNIdHWc2NkCrz65jlU7YrzO6qRp"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./quiz.css" />
  </head>
  <body>
    <div id="quiz-container">
      <div id="logo-container">
        <img src="brain.png" alt="Brainstorming Logo" id="logo" />
      </div>
      <h2>The Ultimate Word Coach Quiz</h2>
      <div id="info-container">
        <div id="timer">Time Left: <span id="time">10</span>s</div>
        <div id="ques_number">Question Number: <span id="number">1</span></div>
        <div id="score">Score: <span id="score-value">0</span></div>
      </div>
      <div id="question-container">
        <div class="question" id="question-1">
          <h2>Loading question...</h2>
          <div class="answers"></div>
        </div>
      </div>
      <div id="feedback" style="display: none"></div>
      <div id="next-container" style="display: none">
        <button id="next-btn" class="next-btn" onclick="loadNextQuestion()">
          Next Question
        </button>
      </div>
    </div>

    <script>
      let countdown;
      let score = 0;
      let currentQuestionIndex = 0;
      let questions = [];

      async function fetchQuestions() {
        try {
          const response = await fetch("/api/questions");
          if (!response.ok) {
            throw new Error("Failed to load questions. Please try again.");
          }
          questions = await response.json();
          if (questions.length > 0) {
            loadNextQuestion();
          } else {
            throw new Error("No questions fetched");
          }
        } catch (error) {
          console.error("Error fetching questions:", error);
          showFeedback("Failed to load questions. Please try again.");
        }
      }

      function startTimer() {
          let timeLeft = 10;
          const timerElement = document.getElementById('time');

          countdown = setInterval(() => {
              if (timeLeft < 0) {
                  clearInterval(countdown);
                  showFeedback("Time's up!");
              } else {
                  timerElement.textContent = timeLeft;
                  timeLeft -= 1;
              }
          }, 1000);
      }

      function checkAnswer(isCorrect, btn) {
          clearInterval(countdown);
          disableAnswers();

          if (isCorrect) {
              score += 10;
              document.getElementById('score-value').textContent = score;
              btn.style.backgroundColor = "green";
          } else {
              btn.style.backgroundColor = "red";
              showCorrectAnswer();
          }

          document.getElementById('next-container').style.display = 'block';
      }

      function showFeedback(message) {
          const feedbackElement = document.getElementById('feedback');
          feedbackElement.style.display = 'block';
          feedbackElement.innerHTML = `<h2>${message}</h2>`;
      }

      function showCorrectAnswer() {
          const currentQuestion = questions[currentQuestionIndex];
          const buttons = document.querySelectorAll('.answer-btn');
          buttons.forEach((btn, index) => {
              if (currentQuestion.answers[index].correct) {
                  btn.style.backgroundColor = "green";
              }
          });
      }

      function disableAnswers() {
          const buttons = document.querySelectorAll('.answer-btn');
          buttons.forEach(btn => {
              btn.disabled = true;
          });
      }

      function loadNextQuestion() {
          if (currentQuestionIndex >= 5) {
              showFeedback("Quiz Completed!");
              document.getElementById('next-container').style.display = 'none';
              return;
          }

          const currentQuestion = questions[currentQuestionIndex];
          const questionContainer = document.getElementById('question-container');
          const questionElement = questionContainer.querySelector('.question h2');
          const answersContainer = questionContainer.querySelector('.answers');

          questionElement.textContent = currentQuestion.question;
          answersContainer.innerHTML = '';

          document.getElementById('number').textContent = currentQuestionIndex + 1; //display question number
          // Display 4 options of answer 
          currentQuestion.answers.forEach(answer => {
              const btn = document.createElement('button');
              btn.textContent = answer.text;
              btn.classList.add('answer-btn');
              btn.onclick = () => checkAnswer(answer.correct, btn);
              answersContainer.appendChild(btn);
          });

          document.getElementById('feedback').style.display = 'none';
          document.getElementById('next-container').style.display = 'none';
          startTimer();
          currentQuestionIndex++;
      }

      document.addEventListener("DOMContentLoaded", fetchQuestions);
    </script>
  </body>
</html>
