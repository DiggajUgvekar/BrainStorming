<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrainStorming Quiz</title>
    <script
      src="https://unpkg.com/htmx.org@2.0.0/dist/htmx.js"
      integrity="sha384-Xh+GLLi0SMFPwtHQjT72aPG19QvKB8grnyRbYBNIdHWc2NkCrz65jlU7YrzO6qRp"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./quiz.css" />
  </head>
  <body>
    <div id="quiz-container">
      <div id="logo-container">
        <img src="brain.png" alt="Brainstorming Logo" id="logo" />
      </div>
      <h2>The Ultimate Word Coach Quiz</h2>
      <div id="info-container">
        <div id="timer">Time Left: <span id="time">10</span>s</div>
        <div id="score">Score: <span id="score-value">0</span></div>
      </div>
      <div id="question-container">
        <div class="question" id="question-1">
          <h2>Loading question...</h2>
          <div class="answers"></div>
        </div>
      </div>
      <div id="feedback" ></div>
      <div id="next-container" >
        <button id="next-btn" class="next-btn" onclick="loadNextQuestion()">
          Next Question
        </button>
      </div>
    </div>

    <script>
      let countdown;
      let score = 0;
      let currentQuestionIndex = 0;
      let questions = [];
      const API_KEY = "fa81optvNubLaGF/JNbesg==YvbvPrLlMCIFT4kh";

      async function fetchQuestions() {
        try {
          const words = await fetchWords(); // Fetch words from words.txt
          questions = [];

          const fetchPromises = words.map(async (word) => {
            const response = await fetch(
              `https://api.api-ninjas.com/v1/thesaurus?word=${word}`,
              {
                headers: {
                  "X-Api-Key": API_KEY,
                },
              }
            );

            if (!response.ok) {
              throw new Error(`Failed to fetch synonyms for ${word}`);
            }

            const data = await response.json();
            const synonyms = data.synonyms;

            if (synonyms.length > 1) {
              // Shuffle the synonyms
              shuffleArray(synonyms);

              // Select one correct answer and three incorrect answers
              const correctAnswer = synonyms[0];
              let incorrectAnswers = synonyms.slice(1, 4); // Take the next three synonyms as incorrect answers

              // Ensure no duplicate answers (correct answer should not match any incorrect answer)
              while (incorrectAnswers.includes(correctAnswer)) {
                shuffleArray(synonyms);
                incorrectAnswers = synonyms.slice(1, 4);
              }

              // Create answer choices array
              const answers = [{ text: correctAnswer, correct: true }];

              incorrectAnswers.forEach((incorrectAnswer) => {
                answers.push({ text: incorrectAnswer, correct: false });
              });

              // Shuffle the answers array
              shuffleArray(answers);

              // Push the question object to questions array
              questions.push({
                question: `What is the synonym of '${word}'?`,
                answers: answers,
              });
            }
          });

          await Promise.all(fetchPromises);

          if (questions.length > 0) {
            loadNextQuestion();
          } else {
            throw new Error("No questions fetched");
          }
        } catch (error) {
          console.error("Error fetching questions:", error);
          showFeedback("Failed to load questions. Please try again.");
        }
      }

      async function fetchWords() {
        try {
          const response = await fetch("/words.txt"); // Assuming words.txt is in the public folder
          if (!response.ok) {
            throw new Error("Failed to fetch words");
          }
          const text = await response.text();
          let words = text.trim().split("\n"); // Split by lines assuming each word is on a new line

          // Shuffle the array of words
          words = shuffleArray(words);

          return words;
        } catch (error) {
          console.error("Error fetching words:", error);
          return [];
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function startTimer() {
        let timeLeft = 10;
        const timerElement = document.getElementById("time");

        countdown = setInterval(() => {
          if (timeLeft < 0) {
            clearInterval(countdown);
            disableAnswers();
            showFeedback("Time's up!");
            showFinalScore();
          } else {
            timerElement.textContent = timeLeft;
            if(timeLeft <= 3){
                timerElement.classList.add('blink');
                timerElement.style.color = 'red';
            }
            else{
                timerElement.classList.add('blink');
            }
            timeLeft -= 1;
          }
        }, 1000);
      }

      function checkAnswer(isCorrect, btn) {
        clearInterval(countdown);
        disableAnswers();

        if (isCorrect) {
          score += 10;
          document.getElementById("score-value").textContent = score;
          btn.style.backgroundColor = "green";
        } else {
          btn.style.backgroundColor = "red";
          showCorrectAnswer();
        }

        document.getElementById("next-container").style.display = "block";
      }

      function showFeedback(message) {
        const feedbackElement = document.getElementById("feedback");
        feedbackElement.style.display = "block";
        feedbackElement.innerHTML = `<h2>${message}</h2>`;
      }

      function showCorrectAnswer() {
        const currentQuestion = questions[currentQuestionIndex];
        const buttons = document.querySelectorAll(".answer-btn");
        buttons.forEach((btn, index) => {
          if (currentQuestion.answers[index].correct) {
            btn.style.backgroundColor = "green";
          }
        });
      }

      function disableAnswers() {
        const buttons = document.querySelectorAll(".answer-btn");
        buttons.forEach((btn) => {
          btn.disabled = true;
        });
      }

      function loadNextQuestion() {
        if (currentQuestionIndex >= questions.length) {
          showFeedback("Quiz Completed!");
          document.getElementById("next-container").style.display = "none";
            showFinalScore();
          return;
        }

        const currentQuestion = questions[currentQuestionIndex];
        const questionContainer = document.getElementById("question-container");
        const questionElement = questionContainer.querySelector(".question h2");
        const answersContainer = questionContainer.querySelector(".answers");

        questionElement.textContent = currentQuestion.question;
        answersContainer.innerHTML = "";

        currentQuestion.answers.forEach((answer) => {
          const btn = document.createElement("button");
          btn.textContent = answer.text;
          btn.classList.add("answer-btn");
          btn.onclick = () => checkAnswer(answer.correct, btn);
          answersContainer.appendChild(btn);
        });

        document.getElementById("feedback").style.display = "none";
        document.getElementById("next-container").style.display = "none";
        startTimer();
        currentQuestionIndex++;
      }

      function showFinalScore(){
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML=   `
        <div id = "final-score">
        <h2>Quiz Completed!</h2>
        <h3>Your final score is: ${score}</h3>
        <button id="restart-btn" class="next-btn" onclick="window.location.reload()">Restart Quiz</button>
        </div>
        `
      }

      document.addEventListener("DOMContentLoaded", fetchQuestions);
    </script>
  </body>
</html>
